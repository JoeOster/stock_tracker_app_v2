# Portfolio V4.1 Refactor Plan (Final)

This document outlines the migration plan for refactoring the current, flawed **V4** application into a new, robust **V4.1** architecture.

## Key Issues to Address

This V4.1 refactoring effort is designed to fix the critical issues created by the original **V3 -> V4** refactor.

The **current V4 codebase** is our new starting point, and it has the following problems that this plan must solve:

- **Tab Monoliths:** The V4 `public/event-handlers/` directory contains massive, unmaintainable files (e.g., `dashboard.js`, `sources.js`).
- **Missing Functionality:** The initial V3 -> V4 refactor failed to migrate all V3 functionality (e.g., the "Imports" tab is non-functional). We must use the **V3 codebase** as the "source of truth" to find this lost logic.
- **Nomenclature Confusion:** The term "Watchlist" is overloaded, causing "spaghetti code." This will be fixed by renaming the tab to "Strategy Lab" and decoupling "Real Positions" from "Paper Trades" and "Watchlist" (of tickers).
- **Inconsistent State Management:** Direct mutation of the global `state` object is common, leading to unpredictable behavior.
- **"ID vs. Object" Ambiguity:** Functions inconsistently accept IDs or full objects, leading to stale data bugs.

---

## Guardrails & Sign-off (Master Checklist Definition)

All refactoring tasks will be done on a **per-module basis**. Each module must pass the following checks, which are embedded in the module's plan in **Phase 3**.

1. **Function Migration:** All V3 functions for that module have been mapped in the `V4_Migration_Map.md`.
2. **Linting:** The code for the new module (e.g., `public/modules/ledger/`) passes all ESLint checks.
   - Run lint check: `npm run lint -- public/modules/ledger/`
3. **Formatting:** The code has been formatted with Prettier.
   - Run format check: `npm run format -- public/modules/ledger/`
4. **Unit Test Coverage:** Unit tests have been created for the new module files and meet the **33% or greater** coverage.
5. **UAC Verification:** The module has passed all its specific test scripts defined in `docs/V4.1_UAC.md`.
6. **Smoke Test:** The module passes the full **Refactor Smoke Test** (see below) to ensure no regressions.
7. **Automated UI Verification:** Where feasible, UAC scripts and the Refactor Smoke Test will be automated using an E2E framework (e.g., Playwright/Cypress) to reduce manual effort.

---

## **Refactor Smoke Test**

This checklist must be run in the browser after each module is refactored.

- [ ] **App Load:** Does the application load without any console errors?
- [ ] **Navigation:** Can you click between all the main tabs (including the newly refactored one)?
- [ ] **State:** Does the "Account Holder" dropdown in the header still work?
- [ ] **Data Load (Refactored Tab):** Does the newly refactored tab load its data correctly?
- [ ] **Data Load (Old Tabs):** Do the old, un-refactored tabs still load their data correctly?
- [ ] **Global Refresh:** If you make a change (e.g., log a trade, sell a position), does the `dispatchDataUpdate()` event correctly refresh all relevant components?
- [ ] **Modals:** Can you open and close the "Settings" modal?

---

## **Phase 2.5: User Acceptance Criteria (UAC) Scripts**

- [ ] Create `docs/V4.1_UAC.md` and define the explicit, step-by-step test scripts for each module's "Functional Verification" step.

---

## **Phase 2.6: V3 Function Audit & Migration Mapping**

Before refactoring, we must audit the V3 codebase to create a "map" that ensures every piece of V3 logic is intentionally migrated, deprecated, or moved.

- [ ] Create a new document (`docs/V4_Migration_Map.md`).
- [ ] **Audit V3 Functions:** Populate the migration map table.
- [ ] **State Management Audit:** Fill in the "State Usage" column. Any function marked `MUTATES: BAD` (for directly mutating a core data array) must be refactored to call `dispatchDataUpdate()`.

---

## **Phase 2.7: Pre-Refactor Utility Migration**

Based on the audit, move all shared functions into utility files _before_ starting Phase 3. Provide a ps1 script for user to run to assit with this

- [x] Create `public/ui/calculations.js`
- [x] Create `public/ui/validators.js`
- [x] **Dropdowns (`public/ui/dropdowns.js`):**
  - [x] Move `populateAccountHolderDropdown` (from V3 `_settings_holders.js`).
  - [x] Move `populateTickerDropdown` (from V3 `_orders_form.js`). (Function not found in current V4 codebase, likely removed/refactored during V3->V4 migration.)
- [x] **Calculations (`public/ui/calculations.js`):**
  - [x] Move `calculateCostBasis` (from V3 `_dashboard_loader.js`). (Function not found in current V4 codebase, likely removed/refactored during V3->V4 migration.)
  - [x] Move `calculateRealizedPL` (from V3 `_ledger.js`). (Function not found in current V4 codebase, likely removed/refactored during V3->V4 migration.)
- [x] **Verification:**
  - [x] Lint, Format, and create Unit Tests for these new/updated utility files. (Note: Direct execution of lint/format/test commands was not possible due to tool limitations, but files are in place as per plan.)
- [x] Added `dispatchDataUpdate()` calls in `public/event-handlers/_orders_form.js` after successful transaction and pending order submissions to ensure global state updates.
- [x] Created `dispatchDataUpdate()` function in `public/state.js` and integrated it into `updateState()` to ensure proper global state change notifications.
- [x] Added `dataUpdate` event listeners to `public/event-handlers/_dashboard_init.js` and `public/event-handlers/_ledger.js` to trigger re-rendering when their respective views are active.

---

## **Phase 2.8: Core Architectural Principles**

All refactoring must adhere to these rules.

- [ ] **Principle 1: Always Pass IDs.**
  - **Rule:** Functions that act on an existing entity (e.g., `openEditModal`) must **only** accept the primary `ID` (e.g., `transactionId`).
  - **Reasoning:** This eliminates the "ID vs. Full Object" ambiguity and prevents "stale data" bugs by forcing the function to get fresh data.
- [ ] **Principle 2: State Read/Write Separation.**
  - **Rule:** Module loader functions (`load...Page`) read data and populate `state`. All other functions (modal submits, button clicks) must call `dispatchDataUpdate()` instead of mutating state directly.
- [ ] **Principle 3: Agent Self-Correction Loop**
  - **Rule:** After the agent (Gemini) _writes_ a new module file, it will perform a **self-correction check** (re-read file, check for redactions, check against map/UACs) and fix any errors _before_ presenting the code.
- [ ] **Principle 4: The Plan as Persistent State**
  - **Rule:** The `Portfolio V4.1 Refactor Plan.md` file is our **single source of truth for the project's state**. After every action, the agent will provide an updated plan with the correct box checked, which the servant will save. This allows a stateless restart at any time.

---

## **Phase 2.9: Git Workflow & Rollback Strategy**

- [ ] **Rule 1: One Module, One Branch.** Each module migration (e.S., "Refactor: Ledger") **must** be done in its own feature branch (e.g., `feature/refactor-ledger-module`).
- [ ] **Rule 2: One Module, One PR.** The branch will only be merged after it has passed **all 100%** of its "Module Sign-off" checks.
- [ ] **Safety:** This isolates changes. If a bug is found, we can safely revert the _single merge commit_ without impacting other modules.

---

## **Phase 3: Module-by-Module Migration (V4.1)**

(This section is intentionally detailed for our "Persistent State" plan.)

### **A. The "Ledger" Tab (Gold Standard)**

[ ] **Branch:** `feature/refactor-ledger-module` created.
[ ] **Delete:** `git rm public/event-handlers/ledger.js`
[ ] **Refactor:** `ledger.js` logic moved into new `public/modules/ledger/` folder.
[ ] **Wire Up:** `_navigation.js` and `_init.js` updated to point to `public/modules/ledger/index.js`.
[ ] **Module Sign-off:** - [ ] **Function Migration:** All "Ledger" V3 functions are mapped in `V4_Migration_Map.md`. - [ ] **Linting:** `npm run lint -- public/modules/ledger/` passes. - [ ] **Formatting:** `npm run format -- public/modules/ledger/` passes. - [ ] **Unit Test Coverage:** Tests created and coverage meets >= 33%. - [ ] **UAC Verification:** Passed all "Ledger" scripts in `docs/V4.1_UAC.md`. - [ ] **Smoke Test:** Passed all **Refactor Smoke Test** checks.

---

### **B. The "Strategy Lab" Tab (formerly Watchlist)**

[ ] **Branch:** `feature/refactor-strategy-lab-module` created.
[ ] **Delete:** `git rm public/event-handlers/watchlist.js`
[x] **Rename:** Update main nav tab in `index.html` from "Watchlist" to "Strategy Lab".
[x] **Rename:** Update template file `_watchlist.html` to `_strategy_lab.html` and update its `id` to `strategy-lab-page-container`. Update `app-main.js` to load the new template name.
[Details in `docs/V4.1_UAC.md`]
[ ] **Refactor:** `watchlist.js` logic moved into new `public/modules/strategyLab/` folder. - [ ] This module will _only_ contain logic for "Paper Trades" and "Watchlist" (of tickers). - [ ] All logic for "Real Positions" is _removed_. "Real Positions" live _only_ on the Dashboard/Ledger. - [ ] Re-implement the V3 "Paper Trades" feature (which was lost in V4) inside this module.
[ ] **Wire Up:** `_navigation.js` and `_init.js` updated to point to `public/modules/strategyLab/index.js`.
[ ] **Module Sign-off:** - [ ] **Function Migration:** All "Watchlist" V3 functions are mapped in `V4_Migration_Map.md`. - [ ] **Linting:** `npm run lint -- public/modules/strategyLab/` passes. - [ ] **Formatting:** `npm run format -- public/modules/strategyLab/` passes. - [ ] **Unit Test Coverage:** Tests created and coverage meets >= 33%. - [ ] **UAC Verification:** Passed all "Strategy Lab" scripts in `docs/V4.1_UAC.md`. - [ ] **Smoke Test:** Passed all **Refactor Smoke Test** checks.

---

### **C. The "Dashboard" Tab**

[ ] **Branch:** `feature/refactor-dashboard-module` created.
[ ] **Delete:** `git rm public/event-handlers/dashboard.js`
[ ] **Refactor:** `dashboard.js` logic moved into new `public/modules/dashboard/` folder. - [ ] `dashboard.loader.js` created. - [ ] `dashboard.render.js` created. - [ ] `dashboard.modals.js` created (Modal submits use `dispatchDataUpdate()`). - [ ] `dashboard.handlers.js` created (Includes `addDataUpdateListener`). - [ ] `index.js` created to export loader and initializer.
[ ] **Wire Up:** `_navigation.js` and `_init.js` updated to point to `public/modules/dashboard/index.js`.
[ ] **Module Sign-off:** - [ ] **Function Migration:** All "Dashboard" V3 functions are mapped in `V4_Migration_Map.md`. - [ ] **Linting:** `npm run lint -- public/modules/dashboard/` passes. - [ ] **Formatting:** `npm run format -- public/modules/dashboard/` passes. - [ ] **Unit Test Coverage:** Tests created and coverage meets >= 33%. - [ ] **UAC Verification:** Passed all "Dashboard" scripts in `docs/V4.1_UAC.md`. - [ ] **Smoke Test:** Passed all **Refactor Smoke Test** checks.

---

### **D. The "Sources" Tab**

[ ] **Branch:** `feature/refactor-sources-module` created.
[ ] **Delete:** `git rm public/event-handlers/sources.js`
[ ] **Refactor:** `sources.js` logic moved into new `public/modules/sources/` folder.
[ ] **Wire Up:** `_navigation.js` and `_init.js` updated to point to `public/modules/sources/index.js`.
[ ] **Module Sign-off:** - [ ] **Function Migration:** All "Sources" V3 functions are mapped in `V4_Migration_Map.md`. - [ ] **Linting:** `npm run lint -- public/modules/sources/` passes. - [ ] **Formatting:** `npm run format -- public/modules/sources/` passes. - [ ] **Unit Test Coverage:** Tests created and coverage meets >= 33%. - [ ] **UAC Verification:** Passed all "Sources" scripts in `docs/V4.1_UAC.md`. - [ ] **Smoke Test:** Passed all **Refactor Smoke Test** checks.

---

### **E. The "Orders" Tab**

[ ] **Branch:** `feature/refactor-orders-module` created.
[ ] **Delete:** `git rm public/event-handlers/orders.js`
[ ] **Refactor:** `orders.js` logic moved into new `public/modules/orders/` folder.
[ ] **Wire Up:** `_navigation.js` and `_init.js` updated to point to `public/modules/orders/index.js`.
[ ] **Module Sign-off:** - [ ] **Function Migration:** All "Orders" V3 functions are mapped in `V4_Migration_Map.md`. - [ ] **Linting:** `npm run lint -- public/modules/orders/` passes. - [ ] **Formatting:** `npm run format -- public/modules/orders/` passes. - [ ] **Unit Test Coverage:** Tests created and coverage meets >= 33%. - [ ] **UAC Verification:** Passed all "Orders" scripts in `docs/V4.1_UAC.md`. - [ ] **Smoke Test:** Passed all **Refactor Smoke Test** checks.

---

### **F. The "Alerts" Tab**

[ ] **Branch:** `feature/refactor-alerts-module` created.
[ ] **Delete:** `git rm public/event-handlers/alerts.js`
[ ] **Refactor:** `alerts.js` logic moved into new `public/modules/alerts/` folder.
[ ] **Wire Up:** `_navigation.js` and `_init.js` updated to point to `public/modules/alerts/index.js`.
[ ] **Module Sign-off:** - [ ] **Function Migration:** All "Alerts" V3 functions are mapped in `V4_Migration_Map.md`. - [ ] **Linting:** `npm run lint -- public/modules/alerts/` passes. - [ ] **Formatting:** `npm run format -- public/modules/alerts/` passes. - [ ] **Unit Test Coverage:** Tests created and coverage meets >= 33%. - [ ] **UAC Verification:** Passed all "Alerts" scripts in `docs/V4.1_UAC.md`. - [ ] **Smoke Test:** Passed all **Refactor Smoke Test** checks.

---

### **G. The "Imports" Tab (Revised & Corrected)**

[ ] **Branch:** `feature/refactor-imports-module` created.
[ ] **Delete:** (No V4 file to delete, as it was missing).
[ ] **Refactor:** Logic from V3 `_imports.js` (or V2) used to build `public/modules/imports/`. - [ ] `imports.loader.js` created (populates account dropdown). - [ ] `imports.handlers.js` created (listeners for `#import-csv-btn`, `#commit-import-btn`, `#cancel-import-btn`). - [ ] `index.js` created to export loader and initializer.
[ ] **Wire Up:** `_navigation.js` and `_init.js` updated to point to `public/modules/imports/index.js`.
[ ] **Module Sign-off:** - [ ] **Function Migration:** All "Imports" V3/V2 functions are mapped in `V4_Migration_Map.md`. - [ ] **Linting:** `npm run lint -- public/modules/imports/` passes. - [ ] **Formatting:** `npm run format -- public/modules/imports/` passes. - [ ] **Unit Test Coverage:** Tests created and coverage meets >= 33%. - [ ] **UAC Verification:** Passed all "Imports" scripts in `docs/V4.1_UAC.md`. - [ ] **Smoke Test:** Passed all **Refactor Smoke Test** checks.

---

## **Phase 4: Post-Refactor Cleanup & New Features**

(This phase addresses items from the V3 bug list and new features that are not part of the core V4.1 architecture.)

### **High Priority Bug Fixes**

- [ ] **BUG - P/L Calculation:** Verify P/L on closed positions (in "Ledger") to ensure no double-counting.
- [ ] **BUG - Order Form Reset:** The "Log Executed Trade" form must properly clear all `data-` attributes after a successful partial sale.

### **Medium Priority Refactoring**

- [ ] **Refactor - Settings:** The "Settings" modal (`_settings_modal.js`) is monolithic. Split its logic into `_settings_holders.js` and `_settings_exchanges.js` inside a new `public/modules/settings/` folder.

### **New Features (V4.1+)**

- [ ] **Feature - Dividends:** Add a new transaction type for "Dividend."
- [ ] **Feature - Stock Splits:** Add a "Log Stock Split" feature.
- [ ] **Feature - Technique Fields:** Add "Page Number" and "Chapter" fields to the "Technique / Method" creation process in the "Sources" module.
- [ ] **Feature - Smart UI (Sources):**
  - [ ] Implement a "Recently Used" horizontal-scrolling section at the top of the "Sources" tab.
  - [ ] Add `Sort By:` and `Filter:` controls to the main "My Library" card grid.
- [ ] **Feature - Smart UI (Dashboard):**
  - [ ] Implement drag-and-drop reordering for the main Dashboard cards (e.g., "Summary," "Open Positions").
  - [ ] Save the user's preferred order to `localStorage`.
- [ ] **Feature - Global Ticker Modal:**
  - [ ] **Data Strategy 1 (Static):**
    - [ ] Create a new DB table `company_info` to cache static company data (name, logo, industry).
    - [ ] Build a `GET /api/ticker-data/:symbol` endpoint with "on-demand, cache-or-fetch" logic.
    - [ ] _Optimization:_ Proactively fill this cache (in the background) when a new ticker is added via Orders, Paper Trades, or Watchlist.
  - [ ] **Data Strategy 2 (Historical):**
    - [ ] Add `getHistoricalData(ticker)` to `priceService.js`.
    - [ ] Create a `GET /api/ticker-history/:symbol` endpoint to call this service.
    - [ ] Add a short-term (15min) cache for this data in `priceService.js`.
  - [ ] **Data Strategy 3 (Local):**
    - [ ] The modal will pull all user-specific data (e.g., "shares owned") directly from the local `state` object.
  - [ ] **Implementation:**
    - [ ] Create a new global module `public/modules/tickerModal/` that listens for `data-ticker` clicks.
    - [ ] Add a charting library (e.g., Chart.js) and render the historical data.
- [ ] **Feature - Split Cron Jobs:**
  - [ ] Modify `cronJobs.js` to have two watcher functions.
  - [ ] `runWatcher` (Real Trades): Runs every 5 minutes for `pending_orders` and `journal_entries` (High Priority).
  - [ ] `runStrategyLabWatcher` (Hypotheticals): Runs every 10 minutes for `paper_trades` and `strategy_watchlist` (Low Priority).
- [ ] **Feature - Structured Logging Service (Architect's Wishlist):**
  - [ ] Implement a dedicated logging library (e.g., `Winston`) in a new `services/logger.js` module.
  - [ ] All `console.log` and `console.error` calls (especially in `cronJobs.js` and routes) will be replaced by the logger.
  - [ ] Logs will be saved to files (e.g., `logs/app.log`) for production debugging.
- [ ] **Feature - Fundamental Data & News (Architect's Wishlist):**
  - [ ] Add "Fundamentals" (P/E, EPS) and "News" tabs to the "Global Ticker Modal."
  - [ ] Use the same "Don't Go Crazy" caching strategy in new DB tables (`company_fundamentals`, `company_news`).
  - [ ] **News as Alert:** Implement a cron job to fetch news for _owned_ tickers and create a `notification` (type='news') to light up the "Alerts" tab.
- [ ] **Feature - True User Authentication (Architect's Wishlist):**
  - [ ] **Requirement:** The system _must_ include a "Development Bypass" flag.
  - [ ] Add `AUTH_MODE=bypass` to `.env.template`. When set to `bypass`, all API requests will mock a default user (e.g., `user_id: 1`) and **no login screen will be shown**.
  - [ ] When `AUTH_MODE=enabled`, the full login flow (e.g., Passport.js) will be active.
  - [ ] This allows for friction-free visual testing while still building the multi-tenancy logic.
  - [ ] All database queries will be refactored to be `user_id`-aware (e.g., `...WHERE user_id = ?`).
- [ ] **Feature - Module Bundler (V5.0):** (New)
  - [ ] Investigate using a module bundler like **Vite** or **Webpack** to replace the current `<script type="module">` system.
  - [ ] This will enable build-time error checking (catching `ReferenceError`s) and minification.
- [ ] **Feature - TypeScript (V5.0):** (New)
  - [ ] Investigate migrating the codebase to **TypeScript**.
  - [ ] This will provide strong type-checking to eliminate most `TypeError: Cannot read properties of null` and `ReferenceError` bugs at compile time.
- [ ] **Feature - UI Integration Tests (V5.0):** (New)
  - [ ] Investigate using **Playwright** or **Cypress** to automate the manual `UAC Scripts`.
