# Portfolio V4.1 Refactor Plan (Final)

This document outlines the migration plan for refactoring the current, flawed **V4** application into a new, robust **V4.1** architecture. This plan refactors the existing **V4.0** codebase, using the **V3.0** codebase only as a "blueprint" to find lost logic.

## Key Issues to Address

This V4.1 refactoring effort is designed to fix the critical issues created by the original **V3 -> V4** refactor.

- **Tab Monoliths:** The V4 `public/event-handlers/` directory contains massive, unmaintainable files (e.g., `dashboard.js`, `sources.js`).
- **Missing Functionality:** The initial V3 -> V4 refactor failed to migrate all V3 functionality (e.g., the "Imports" tab is non-functional).
- **Nomenclature Confusion:** The terms "Watchlist" and "Pending Orders" are ambiguous. This will be fixed by renaming:
  - "Watchlist" tab -> **"Strategy Lab" tab**.
  - "Orders" tab -> **"Limit Orders" tab**.
  - This decouples "Real Positions" from "Paper Trades" and "Watchlist" (of tickers).
- **Unlinked Strategies:** A "Strategy" (journal entry) is not programmatically linked to the "Limit Orders" it generates. This will be fixed by adding a `journal_entry_id` to the `pending_orders` table.
- **"ID vs. Object" Ambiguity:** Functions inconsistently accept IDs or full objects, leading to stale data bugs.
- **Agent Errors:** `ReferenceError` and `TypeError` bugs are common from cross-wired or missing code. This plan's guardrails are designed to prevent them.

---

## Guardrails & Sign-off (Master Checklist Definition)

All refactoring tasks will be done on a **per-module basis**. Each module must pass the following checks, which are embedded in the module's plan in **Phase 3**.

1. **Function Migration:** All V3/V4 functions for that module have been mapped in the `V4_Migration_Map.md`.
2. **Wiring Guide:** All UI interactions for the module are defined in `V4.1_Wiring_Guide.md`.
3. **Linting:** The code for the new module (e.g., `public/modules/ledger/`) passes all ESLint checks.
   - Run lint check: `npm run lint -- public/modules/ledger/`
4. **Formatting:** The code has been formatted with Prettier.
   - Run format check: `npm run format -- public/modules/ledger/`
5. **Unit Test Coverage:** Unit tests have been created for the new module files and meet the **67% or greater** coverage.
6. **UAC Verification:** The module has passed all its specific test scripts defined in `docs/V4.1_UAC.md`.
7. **Smoke Test:** The module passes the full **Refactor Smoke Test** (see below) to ensure no regressions.

---

## **Refactor Smoke Test**

This checklist must be run in the browser after each module is refactored.

- [ ] **App Load:** Does the application load without any console errors?
- [ ] **Navigation:** Can you click between all the main tabs (including the newly refactored one)?
- [ ] **State:** Does the "Account Holder" dropdown in the header still work?
- [ ] **Data Load (Refactored Tab):** Does the newly refactored tab load its data correctly?
- [ ] **Data Load (Old Tabs):** Do the old, un-refactored tabs still load their data correctly?
- [ ] **Global Refresh:** If you make a change (e.g., log a trade, sell a position), does the `dispatchDataUpdate()` event correctly refresh all relevant components?
- [ ] **Modals:** Can you open and close the "Settings" modal?

---

## **Phase 2.5: User Acceptance Criteria (UAC) Scripts**

- [ ] Create `docs/V4.1_UAC.md` and define the explicit, step-by-step test scripts for each module's "Functional Verification" step.

---

## **Phase 2.6: V3/V4 Function Audit & Migration Mapping**

Before refactoring, we must audit the codebase to create a "map" that ensures every piece of logic is intentionally migrated, deprecated, or moved.

- [ ] Create a new document (`docs/V4_Migration_Map.md`).
- [ ] **Audit Functions:** Populate the migration map table (using V4.0 as target, V3 as reference for lost logic).
- [ ] **State Management Audit:** Fill in the "State Usage" column. Any function marked `MUTATES: BAD` (for directly mutating a core data array) must be refactored to call `dispatchDataUpdate()`.

---

## **Phase 2.6.5: UI Wiring Guide**

- [ ] Create a new document (`docs/V4.1_Wiring_Guide.md`).
- [ ] This document will explicitly map HTML Element IDs to their **"Purpose (Human-Readable)"** and their **"Handler Function (for Agent)"**.
- [ ] This serves as the "contract" for all UI interactions and will be used by the agent's "Self-Correction Loop" (Principle 3) to prevent `TypeError` and `ReferenceError` bugs.

---

## **Phase 2.7: Pre-Refactor Utility Migration (Automated)**

Based on the audit, move all shared functions into utility files _before_ starting Phase 3.

- [ ] **Create `tools/migration/PS1_Phase_2_7_Utilities.ps1` script.**
- [ ] The agent will provide the content for this PowerShell script. The script will be responsible for:
  - [ ] 1. Creating the new file `public/ui/calculations.js` with all required functions.
  - [ ] 2. Creating the new file `public/ui/validators.js` with all required functions.
  - [ ] 3. Modifying `public/ui/dropdowns.js` to add the `populateAccountHolderDropdown` and `populateTickerDropdown` functions.
- [ ] **Execute Script:** Run the PowerShell script.
- [ ] **Verification:**
  - [ ] Lint, Format, and create/update Unit Tests for the new/modified utility files.

---

## **Phase 2.8: Core Architectural Principles**

All refactoring must adhere to these rules.

- [ ] **Principle 1: Always Pass IDs.**
  - **Rule:** Functions that act on an existing entity (e.g., `openEditModal`) must **only** accept the primary `ID` (e.g., `transactionId`).
  - **Reasoning:** This eliminates the "ID vs. Full Object" ambiguity and prevents "stale data" bugs by forcing the function to get fresh data.
- [ ] **Principle 2: State Read/Write Separation.**
  - **Rule:** Module loader functions (`load...Page`) read data and populate `state`. All other functions (modal submits, button clicks) must call `dispatchDataUpdate()` instead of mutating state directly.
- [ ] **Principle 3: Agent Self-Correction Loop**
  - **Rule:** After the agent (Gemini) _writes_ a new module file, it will perform a **self-correction check** (re-read file, check for redactions, check against `V4_Migration_Map.md` and `V4.1_Wiring_Guide.md`) and fix any errors _before_ presenting the code.
- [ ] **Principle 4: The Plan as Persistent State**
  - **Rule:** The `Portfolio V4.1 Refactor Plan.md` file is our **single source of truth for the project's state**. After every action, the agent will provide an updated plan with the correct box checked, which the servant will save. This allows a stateless restart at any time.

---

## **Phase 2.9: Git Workflow & Rollback Strategy**

- [ ] **Rule 1: One Module, One Branch.** Each module migration (e.S., "Refactor: Ledger") **must** be done in its own feature branch (e.g., `feature/refactor-ledger-module`).
- [ ] **Rule 2: One Module, One PR.** The branch will only be merged after it has passed **all 100%** of its "Module Sign-off" checks.
- [ ] **Safety:** This isolates changes. If a bug is found, we can safely revert the _single merge commit_ without impacting other modules.

---

## **Phase 2.9.5: Database Migration**

- [ ] **Create Migration File:** Create `Portfolio V4/migrations/002-link-orders-to-journal.sql`.
- [ ] The migration will add a nullable `journal_entry_id` column to the `pending_orders` table, with a foreign key to `journal_entries(id)`.
- [ ] **Run Migration:** Run the database migration script to apply the schema change.

---

## **Phase 3: Module-by-Module Migration (V4.1)**

This phase refactors the V4 "monoliths" from `public/event-handlers/` into the new `public/modules/` structure in a logical, dependency-first order.

---

### **A. Module: Settings (Modal)**

_(**Dependency:** Required by Limit Orders & Imports for account population)_
[ ] **Branch:** `feature/refactor-settings-module` created.
[ ] **Refactor:** `_settings_modal.js`, `_settings_holders.js`, and `_settings_exchanges.js` logic moved into new `public/modules/settings/` folder.
[ ] **Wire Up:** `_init.js` updated to call `initializeSettingsHandlers()` from `public/modules/settings/index.js`.
[ ] **Module Sign-off:** - [ ] **Function Migration:** Mapped in `V4_Migration_Map.md`. - [ ] **Wiring Guide:** Mapped in `V4.1_Wiring_Guide.md`. - [ ] **Linting:** `npm run lint -- public/modules/settings/` passes. - [ ] **Formatting:** `npm run format -- public/modules/settings/` passes. - [ ] **Unit Test Coverage:** Tests created and coverage meets >= 67%. - [ ] **UAC Verification:** Passed all "Settings" scripts in `docs/V4.1_UAC.md`. - [ ] **Smoke Test:** Passed all **Refactor Smoke Test** checks.

---

### **B. Module: Limit Orders (Tab)**

*(**Dependency:** Primary data *input* for the app. Formerly "Orders" tab.)*
[ ] **Branch:** `feature/refactor-limit-orders-module` created.
[ ] **Delete:** `git rm public/event-handlers/orders.js`
[ ] **Rename (UI):** - [ ] Update main nav tab in `public/index.html` from "Orders" to "Limit Orders". - [ ] Update `public/templates/_orders.html`: change `id` to `limit-orders-page-container`. - [ ] Update `public/templates/_orders.html`: change all UI text from "Pending Orders" to "Open Limit Orders" and "Executed Trades" to "Filled Orders".
[ ] **Rename (Code):** - [ ] Update `app-main.js` to load the `_orders.html` template. - [ ] Update `_navigation.js` to use `case 'orders':` but call `loadLimitOrdersPage()`. - [ ] Update `_init.js` to call `initializeLimitOrdersHandlers()`.
[ ] **Refactor:** `orders.js` logic moved into new `public/modules/limitOrders/` folder. - [ ] `checkAndPrefillForm` in `limitOrders.loader.js` **must** be updated to read `journal_entry_id` from `state.prefillOrderFromSource` and store it in `form.dataset.journalId`. - [ ] `handleSubmitOrderClick` in `limitOrders.handlers.js` **must** be updated to read `form.dataset.journalId` and pass `journal_entry_id` to the API.
[ ] **Wire Up:** `_navigation.js` and `_init.js` updated to point to `public/modules/limitOrders/index.js`.
[ ] **Module Sign-off:** - [ ] **Function Migration:** Mapped in `V4_Migration_Map.md`. - [ ] **Wiring Guide:** Mapped in `V4.1_Wiring_Guide.md`. - [ ] **Linting:** `npm run lint -- public/modules/limitOrders/` passes. - [ ] **Formatting:** `npm run format -- public/modules/limitOrders/` passes. - [ ] **Unit Test Coverage:** Tests created and coverage meets >= 67%. - [ ] **UAC Verification:** Passed all "Orders" scripts in `docs/V4.1_UAC.md`. - [ ] **Smoke Test:** Passed all **Refactor Smoke Test** checks.

---

### **C. Module: Ledger (Tab)**

*(**Dependency:** Primary data *output*. Depends on `Limit Orders` to have data.)*
[ ] **Branch:** `feature/refactor-ledger-module` created.
[ ] **Delete:** `git rm public/event-handlers/ledger.js`
[ ] **Refactor:** `ledger.js` logic moved into new `public/modules/ledger/` folder.
[ ] **Wire Up:** `_navigation.js` and `_init.js` updated to point to `public/modules/ledger/index.js`.
[ ] **Module Sign-off:** - [ ] **Function Migration:** Mapped in `V4_Migration_Map.md`. - [ ] **Wiring Guide:** Mapped in `V4.1_Wiring_Guide.md`. - [ ] **Linting:** `npm run lint -- public/modules/ledger/` passes. - [ ] **Formatting:** `npm run format -- public/modules/ledger/` passes. - [ ] **Unit Test Coverage:** Tests created and coverage meets >= 67%. - [ ] **UAC Verification:** Passed all "Ledger" scripts in `docs/V4.1_UAC.md`. - [ ] **Smoke Test:** Passed all **Refactor Smoke Test** checks.

---

### **D. Module: Dashboard (Tab)**

*(**Dependency:** Complex data *output*. Depends on `Ledger` and `Limit Orders`.)*
[ ] **Branch:** `feature/refactor-dashboard-module` created.
[ ] **Delete:** `git rm public/event-handlers/dashboard.js`
[ ] **Refactor:** `dashboard.js` logic moved into new `public/modules/dashboard/` folder.
[ ] **Wire Up:** `_navigation.js` and `_init.js` updated to point to `public/modules/dashboard/index.js`.
[ ] **Module Sign-off:** - [ ] **Function Migration:** Mapped in `V4_Migration_Map.md`. - [ ] **Wiring Guide:** Mapped in `V4.1_Wiring_Guide.md`. - [ ] **Linting:** `npm run lint -- public/modules/dashboard/` passes. - [ ] **Formatting:** `npm run format -- public/modules/dashboard/` passes. - [ ] **Unit Test Coverage:** Tests created and coverage meets >= 67%. - [ ] **UAC Verification:** Passed all "Dashboard" scripts in `docs/V4.1_UAC.md`. - [ ] **Smoke Test:** Passed all **Refactor Smoke Test** checks.

---

### **E. Module: Sources (Tab)**

_(**Dependency:** "Pre-input" to `Limit Orders`. Depends on `Limit Orders` to test the prefill link.)_
[ ] **Branch:** `feature/refactor-sources-module` created.
[ ] **Delete:** `git rm public/event-handlers/sources.js`
[ ] **Refactor:** `sources.js` logic moved into new `public/modules/sources/` folder. - [ ] The "Buy" button handler (`handleCreateBuyOrderFromIdea`) **must** be updated to add `journal_entry_id` to the `prefillData` object it sends to `state.prefillOrderFromSource`.
[ ] **Wire Up:** `_navigation.js` and `_init.js` updated to point to `public/modules/sources/index.js`.
[ ] **Module Sign-off:** - [ ] **Function Migration:** Mapped in `V4_Migration_Map.md`. - [ ] **Wiring Guide:** Mapped in `V4.1_Wiring_Guide.md`. - [ ] **Linting:** `npm run lint -- public/modules/sources/` passes. - [ ] **Formatting:** `npm run format -- public/modules/sources/` passes. - [ ] **Unit Test Coverage:** Tests created and coverage meets >= 67%. - [ ] **UAC Verification:** Passed all "Sources" scripts in `docs/V4.1_UAC.md`. - [ ] **Smoke Test:** Passed all **Refactor Smoke Test** checks.

---

### **F. Module: Alerts (Tab)**

_(**Dependency:** Depends on `Limit Orders` (for `pending_orders`) and `Sources` (for `journal_entries`).)_
[ ] **Branch:** `feature/refactor-alerts-module` created.
[ ] **Delete:** `git rm public/event-handlers/alerts.js`
[ ] **Refactor:** `alerts.js` logic moved into new `public/modules/alerts/` folder.
[ ] **Wire Up:** `_navigation.js` and `_init.js` updated to point to `public/modules/alerts/index.js`.
[ ] **Module Sign-off:** - [ ] **Function Migration:** Mapped in `V4_Migration_Map.md`. - [ ] **Wiring Guide:** Mapped in `V4.1_Wiring_Guide.md`. - [ ] **Linting:** `npm run lint -- public/modules/alerts/` passes. - [ ] **Formatting:** `npm run format -- public/modules/alerts/` passes. - [ ] **Unit Test Coverage:** Tests created and coverage meets >= 67%. - [ ] **UAC Verification:** Passed all "Alerts" scripts in `docs/V4.1_UAC.md`. - [ ] **Smoke Test:** Passed all **Refactor Smoke Test** checks.

---

### **G. Module: Strategy Lab (Tab)**

_(**Dependency:** Fully decoupled. Can be built once the main app is stable. Formerly "Watchlist" tab.)_
[ ] **Branch:** `feature/refactor-strategy-lab-module` created.
[ ] **Delete:** `git rm public/event-handlers/watchlist.js`
[ ] **Rename (UI):** - [ ] Update main nav tab in `public/index.html` from "Watchlist" to "Strategy Lab". - [ ] Update `public/templates/_watchlist.html` to `_strategy_lab.html` and update its `id` to `strategy-lab-page-container`.
[ ] **Rename (Code):** - [ ] Update `app-main.js` to load the new `_strategy_lab.html` template. - [ ] Update `_navigation.js` to use `case 'watchlist':` but call `loadStrategyLabPage()`. - [ ] Update `_init.js` to call `initializeStrategyLabHandlers()`.
[ ] **Refactor:** `watchlist.js` logic moved into new `public/modules/strategyLab/` folder. - [ ] This module will _only_ contain logic for "Paper Trades" and "Watchlist" (of tickers). - [ ] All logic for "Real Positions" (V3 `_watchlist_real.js`) is **removed**. - [ ] Re-implement the V3 "Paper Trades" feature (which was lost in V4) inside this module.
[ ] **Wire Up:** `_navigation.js` and `_init.js` updated to point to `public/modules/strategyLab/index.js`.
[ ] **Module Sign-off:** - [ ] **Function Migration:** Mapped in `V4_Migration_Map.md`. - [ ] **Wiring Guide:** Mapped in `V4.1_Wiring_Guide.md`. - [ ] **Linting:** `npm run lint -- public/modules/strategyLab/` passes. - [ ] **Formatting:** `npm run format -- public/modules/strategyLab/` passes. - [ ] **Unit Test Coverage:** Tests created and coverage meets >= 67%. - [ ] **UAC Verification:** Passed all "Strategy Lab" scripts in `docs/V4.1_UAC.md`. - [ ] **Smoke Test:** Passed all **Refactor Smoke Test** checks.

---

### **H. Module: Imports (Tab)**

_(**Dependency:** Most complex input. Depends on `Settings` (for accounts) and `Ledger` (for conflict checks).)_
[ ] **Branch:** `feature/refactor-imports-module` created.
[ ] **Delete:** (No V4 file to delete, as it was missing).
[ ] **Refactor:** Logic from V3 `_imports.js` (or V2) used to build `public/modules/imports/`. - [ ] `imports.loader.js` created (populates account dropdown). - [ ] `imports.handlers.js` created (listeners for `#import-csv-btn`, `#commit-import-btn`, `#cancel-import-btn`). - [ ] `index.js` created to export loader and initializer.
[ ] **Wire Up:** `_navigation.js` and `_init.js` updated to point to `public/modules/imports/index.js`.
[ ] **Module Sign-off:** - [ ] **Function Migration:** Mapped in `V4_Migration_Map.md`. - [ ] **Wiring Guide:** Mapped in `V4.1_Wiring_Guide.md`. - [ ] **Linting:** `npm run lint -- public/modules/imports/` passes. - [ ] **Formatting:** `npm run format -- public/modules/imports/` passes. - [ ] **Unit Test Coverage:** Tests created and coverage meets >= 67%. - [ ] **UAC Verification:** Passed all "Imports" scripts in `docs/V4.1_UAC.md`. - [ ] **Smoke Test:** Passed all **Refactor Smoke Test** checks.

---

## **Phase 4: Post-Refactor Cleanup & New Features**

(This phase addresses items from the V3 bug list and new features that are not part of the core V4.1 architecture.)

### **High Priority Bug Fixes**

- [ ] **BUG - P/L Calculation:** Verify P/L on closed positions (in "Ledger") to ensure no double-counting.
- [ ] **BUG - Order Form Reset:** The "Log Executed Trade" form must properly clear all `data-` attributes after a successful partial sale.

### **New Features (V4.1+)**

- [ ] **Feature - Dividends:** Add a new transaction type for "Dividend."
- [ ] **Feature - Stock Splits:** Add a "Log Stock Split" feature.
- [ ] **Feature - Technique Fields:** Add "Page Number" and "Chapter" fields to the "Technique / Method" creation process in the "Sources" module.
- [ ] **Feature - Smart UI (Sources):**
  - [ ] Implement a "Recently Used" horizontal-scrolling section at the top of the "Sources" tab.
  - [ ] Add `Sort By:` and `Filter:` controls to the main "My Library" card grid.
- [ ] **Feature - Smart UI (Dashboard):**
  - [ ] Implement drag-and-drop reordering for the main Dashboard cards (e.g., "Summary," "Open Positions").
  - [ ] Save the user's preferred order to `localStorage`.
- [ ] **Feature - Global Ticker Modal:**
  - [ ] **Data Strategy 1 (Static):**
    - [ ] Create a new DB table `company_info` to cache static company data (name, logo, industry).
    - [ ] Build a `GET /api/ticker-data/:symbol` endpoint with "on-demand, cache-or-fetch" logic.
    - [ ] _Optimization:_ Proactively fill this cache (in the background) when a new ticker is added via Limit Orders, Paper Trades, or Watchlist.
  - [ ] **Data Strategy 2 (Historical):**
    - [ ] Add `getHistoricalData(ticker)` to `priceService.js`.
    - [ ] Create a `GET /api/ticker-history/:symbol` endpoint to call this service.
    - [ ] Add a short-term (15min) cache for this data in `priceService.js`.
  - [ ] **Data Strategy 3 (Local):**
    - [ ] The modal will pull all user-specific data (e.g., "shares owned") directly from the local `state` object.
  - [ ] **Implementation:**
    - [ ] Create a new global module `public/modules/tickerModal/` that listens for `data-ticker` clicks.
    - [ ] Add a charting library (e.g., Chart.js) and render the historical data.
- [ ] **Feature - Split Cron Jobs:**
  - [ ] Modify `cronJobs.js` to have two watcher functions.
  - [ ] `runWatcher` (Real Trades): Runs every 5 minutes for `pending_orders` and `journal_entries` (High Priority).
  - [ ] `runStrategyLabWatcher` (Hypotheticals): Runs every 10 minutes for `paper_trades` and `strategy_watchlist` (Low Priority).
- [ ] **Feature - Structured Logging Service (Architect's Wishlist):**
  - [ ] Implement a dedicated logging library (e.g., `Winston`) in a new `services/logger.js` module.
  - [ ] All `console.log` and `console.error` calls (especially in `cronJobs.js` and routes) will be replaced by the logger.
  - [ ] Logs will be saved to files (e.g., `logs/app.log`) for production debugging.
- [ ] **Feature - Fundamental Data & News (Architect's Wishlist):**
  - [ ] Add "Fundamentals" (P/E, EPS) and "News" tabs to the "Global Ticker Modal."
  - [ ] Use the same "Don't Go Crazy" caching strategy in new DB tables (`company_fundamentals`, `company_news`).
  - [ ] **News as Alert:** Implement a cron job to fetch news for _owned_ tickers and create a `notification` (type='news') to light up the "Alerts" tab.
- [ ] **Feature - True User Authentication (Architect's Wishlist):**
  - [ ] **Requirement:** The system _must_ include a "Development Bypass" flag.
  - [ ] Add `AUTH_MODE=bypass` to `.env.template`. When set to `bypass`, all API requests will mock a default user (e.g., `user_id: 1`) and **no login screen will be shown**.
  - [ ] When `AUTH_MODE=enabled`, the full login flow (e.g., Passport.js) will be active.
  - [ ] This allows for friction-free visual testing while still building the multi-tenancy logic.
  - [ ] All database queries will be refactored to be `user_id`-aware (e.g., `...WHERE user_id = ?`).
- [ ] **Feature - V5.0: Unify Transactions Table:**
  - [ ] Architect a new migration to merge the `pending_orders` table into the `transactions` table, using a `status` column ('PENDING', 'FILLED', 'CANCELLED'). This would be a major V5.0+ undertaking.
- [ ] **Feature - Module Bundler (V5.0):**
  - [ ] Investigate using a module bundler like **Vite** or **Webpack** to replace the current `<script type"module">` system.
  - [ ] This will enable build-time error checking (catching `ReferenceError`s) and minification.
- [ ] **Feature - TypeScript (V5.0):**
  - [ ] Investigate migrating the codebase to **TypeScript**.
  - [ ] This will provide strong type-checking to eliminate most `TypeError: Cannot read properties of null` and `ReferenceError` bugs at compile time.
- [ ] **Feature - UI Integration Tests (V5.0):**
  - [ ] Investigate using **Playwright** or **Cypress** to automate the manual `UAC Scripts`.
